# Original script: http://www.sharepointdiary.com/2016/02/how-to-check-replicate-directory-changes-permission.html
# Modified by wildkindcc
# Will be required to import the active direcotry module for this to work.
# Import-module activedirectory
 
#$UserProfileAccountName = "HTB\mrlky"
$UserProfileAccountName = "$env:UserDomain\$env:UserName"
 
Function Check-ADUserPermission(
    [System.DirectoryServices.DirectoryEntry]$entry, 
    [string]$user, 
    [string]$permission)
{
    $dse = [ADSI]"LDAP://Rootdse"
    $ext = [ADSI]("LDAP://CN=Extended-Rights," + $dse.ConfigurationNamingContext)
 
    $right = $ext.psbase.Children | 
        ? { $_.DisplayName -eq $permission }
 
    if($right -ne $null)
    {
        $perms = $entry.psbase.ObjectSecurity.Access |
            ? { $_.IdentityReference -eq $user } |
            ? { $_.ObjectType -eq [GUID]$right.RightsGuid.Value }
 
        return ($perms -ne $null)
    }
    else
    {
        Write-Warning "Permission '$permission' not found."
        return $false
    }
}
 
Function Check-ReplicateChanges([string]$userName, [string]$replicationPermissionName)
{
 
    # Main()
    $dse = [ADSI]"LDAP://Rootdse"
 
    $entries = @(
        [ADSI]("LDAP://" + $dse.defaultNamingContext)
 
        # I dont think this is necessary for DCSync
        # [ADSI]("LDAP://" + $dse.configurationNamingContext)
        );
    echo " User '$userName': "
 
    foreach($entry in $entries)
    {
        $result = Check-ADUserPermission $entry $userName $replicationPermissionName
        if($result)
        {
            #echo "   has '$replicationPermissionName' permissions on '$($entry.distinguishedName)'"
            echo "$replicationPermissionName configured for $username"
        }
    }
}
 
#Check-ReplicateChanges $UserProfileAccountName "Replicating Directory Changes"
#Check-ReplicateChanges $UserProfileAccountName "Replicating Directory Changes All"

if (Check-ReplicateChanges $UserProfileAccountName "Replicating Directory Changes" -and Check-ReplicateChanges $UserProfileAccountName "Replicating Directory Changes All") {
    echo "$UserProfileAccountName can likely perform DCSync Attack."
}
